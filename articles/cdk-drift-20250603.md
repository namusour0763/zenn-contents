---
title: "AWS CDK ã§ä½œæˆã—ãŸãƒªã‚½ãƒ¼ã‚¹ã‚’å¤‰æ›´ã™ã‚‹ã¨ã©ã†ãªã‚‹ï¼Ÿ"
emoji: "ğŸ§©"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["AWS", "AWSCDK", "Terraform"]
published: false
---

## ã¯ã˜ã‚ã«

AWS CDK ã§ä½œæˆã—ãŸãƒªã‚½ãƒ¼ã‚¹ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰å¤‰æ›´ã™ã‚‹ã¨ã€å®Ÿæ©Ÿã¨ã‚³ãƒ¼ãƒ‰ã«å·®åˆ†ãŒç”Ÿã¾ã‚Œã¦ã—ã¾ã„ã¾ã™ã€‚ã“ã®ã¨ãã®æŒ™å‹•ã‚’ Terraform ã¨æ¯”ã¹ãŸãèª¿æŸ»ã—ã¾ã—ãŸã€‚

## æ¤œè¨¼å†…å®¹ã¨æ¤œè¨¼çµæœï¼ˆæ¦‚è¦ï¼‰

1. CDK ã§ S3 ãƒã‚±ãƒƒãƒˆã‚’ä½œæˆ
1. `cdk deploy` ã™ã‚‹
1. S3 ãƒã‚±ãƒƒãƒˆã«ãƒãƒã‚³ãƒ³ã‹ã‚‰æ–°è¦ã«ã‚¿ã‚°ã‚’ä»˜ä¸
1. `cdk diff` ã‚’å®Ÿè¡Œ â†’ å·®åˆ†è¡¨ç¤ºãªã— `Number of stacks with differences: 0`
1. `cdk deploy` ã‚’å®Ÿè¡Œ â†’ å¤‰æ›´ãªã— `CdkTestStack (no changes)`
1. CDK ã®ã‚³ãƒ¼ãƒ‰å†…ã§ä¸Šè¨˜ã¨ç•°ãªã‚‹æ–°è¦ã®ã‚¿ã‚°ã‚’ä»˜ä¸
1. `cdk diff` ã‚’å®Ÿè¡Œ â†’å·®åˆ†è¡¨ç¤ºã‚ã‚Š ãŸã ã—ãƒãƒã‚³ãƒ³ã§ä»˜ä¸ã—ãŸã‚¿ã‚°ãŒæ¶ˆãˆã‚‹è¡¨ç¤ºã¯ãªã—
1. `cdk deploy` ã‚’å®Ÿè¡Œ â†’ å¤‰æ›´ã‚ã‚Š CDK ã®ã‚¿ã‚°ãŒä»˜ä¸ã•ã‚Œã€ãƒãƒã‚³ãƒ³ã§ä»˜ä¸ã—ãŸã‚¿ã‚°ãŒæ¶ˆå¤±

## æ¤œè¨¼çµæœï¼ˆè©³ç´°ï¼‰

### ãƒãƒã‚³ãƒ³ã‹ã‚‰ã‚¿ã‚°ã‚’ä»˜ä¸ã—ãŸã®ã¿ã§ã€ã‚³ãƒ¼ãƒ‰ã¯å¤‰æ›´ã—ãªã„å ´åˆ

:::details ã‚¿ãƒ¼ãƒŸãƒŠãƒ«

```text
namusour@DESKTOP-K4JMPSM:~/cdk_test$ cdk diff --profile some-profile
Stack CdkTestStack
Hold on while we create a read-only change set to get a diff with accurate replacement information (use --no-change-set to use a less accurate but faster template-only diff)
There were no differences

âœ¨  Number of stacks with differences: 0

namusour@DESKTOP-K4JMPSM:~/cdk_test$ cdk deploy --profile some-profile

âœ¨  Synthesis time: 4.26s

CdkTestStack: deploying... [1/1]

 âœ…  CdkTestStack (no changes)

âœ¨  Deployment time: 0.18s

Stack ARN:
arn:aws:cloudformation:ap-northeast-1:xxxxxxxxxxxx:stack/CdkTestStack/75d7de10-a80c-11ef-96c9-0e569e4b2f3d

âœ¨  Total time: 4.44s
```

:::

![](/images/cdk-drift-20250603/before.png)
*æ‰‹å‹•ã§ã¤ã‘ãŸ owner: alice ã‚¿ã‚°ãŒæ®‹ã£ã¦ã„ã‚‹*

### ãƒãƒã‚³ãƒ³ã‹ã‚‰ã‚¿ã‚°ã‚’ä»˜ä¸ã—ã€ã‚³ãƒ¼ãƒ‰ã‹ã‚‰ã‚‚å¤‰æ›´ã—ãŸå ´åˆ

:::details ã‚¿ãƒ¼ãƒŸãƒŠãƒ«

```text
namusour@DESKTOP-K4JMPSM:~/cdk_test$ cdk diff --profile some-profile
Stack CdkTestStack
Hold on while we create a read-only change set to get a diff with accurate replacement information (use --no-change-set to use a less accurate but faster template-only diff)
Resources
[~] AWS::S3::Bucket CDKFirstBucket-20241121 CDKFirstBucket202411217D68ED46 
 â””â”€ [+] Tags
     â””â”€ [{"Key":"CreatedBy","Value":"CDK"}]


âœ¨  Number of stacks with differences: 1

namusour@DESKTOP-K4JMPSM:~/cdk_test$ cdk deploy --profile some-profile

âœ¨  Synthesis time: 4.28s

CdkTestStack: deploying... [1/1]
CdkTestStack: creating CloudFormation changeset...

 âœ…  CdkTestStack

âœ¨  Deployment time: 37.15s

Stack ARN:
arn:aws:cloudformation:ap-northeast-1:xxxxxxxxxxxx:stack/CdkTestStack/75d7de10-a80c-11ef-96c9-0e569e4b2f3d

âœ¨  Total time: 41.43s
```

:::

![](/images/cdk-drift-20250603/after.png)
*æ‰‹å‹•ã§ã¤ã‘ãŸ owner: alice ã‚¿ã‚°ãŒæ¶ˆãˆã€ã‚³ãƒ¼ãƒ‰ã®å€¤ã§ä¸Šæ›¸ãã•ã‚Œã‚‹*

### CloudFormation ã®ç”»é¢ã‹ã‚‰ã€æ‰‹å‹•ã§ãƒ‰ãƒªãƒ•ãƒˆã®æ¤œå‡ºã‚’ã—ãŸå ´åˆ

![](/images/cdk-drift-20250603/drift1.png)
![](/images/cdk-drift-20250603/drift2.png)
![](/images/cdk-drift-20250603/drift3.png)
*ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ãƒ‰ãƒªãƒ•ãƒˆã®æ¤œå‡ºã‚’ã—ãŸå ´åˆã¯ã€å®Ÿæ©Ÿã¨ã®å·®åˆ†ãŒã‚ã‹ã‚‹*

## ã¾ã¨ã‚

- `terarform plan` ã¯ã€Œæ‰‹å…ƒã® tf ãƒ•ã‚¡ã‚¤ãƒ«ã€ã¨ã€Œãƒ‡ãƒ—ãƒ­ã‚¤æ¸ˆã¿ã®å®Ÿãƒªã‚½ãƒ¼ã‚¹ã€ã‚’æ¯”è¼ƒã™ã‚‹
- `cdk diff` ã¯ã€Œæ‰‹å…ƒã® CDK App ã® Synth çµæœã€ã¨ã€Œãƒ‡ãƒ—ãƒ­ã‚¤æ¸ˆã¿ã® CloudFormation Stackã€ã‚’æ¯”è¼ƒã™ã‚‹
- ã‚†ãˆã« CDK ã§ã¯å®Ÿæ©Ÿã®å¤‰æ›´ã«æ°—ä»˜ã‹ãšå·»ãæˆ»ã—ã¦ã—ã¾ã†å¯èƒ½æ€§ãŒé«˜ãã€ã‚ˆã‚Šæ³¨æ„ãŒå¿…è¦

|                   | ã‚³ãƒ³ã‚½ãƒ¼ãƒ«æ“ä½œã‚ã‚Š   | ã‚³ãƒ³ã‚½ãƒ¼ãƒ«æ“ä½œï¼‹ã‚³ãƒ¼ãƒ‰å¤‰æ›´ã‚ã‚Š     |
| ----------------- | -------------------- | ---------------------------------- |
| `terraform plan`  | å·®åˆ†ã‚ã‚Šï¼ˆå·»ãæˆ»ã‚Šï¼‰ | å·®åˆ†ã‚ã‚Šï¼ˆå·»ãæˆ»ã‚Šï¼‹å¤‰æ›´å·®åˆ†ï¼‰     |
| `cdk diff`        | å·®åˆ†ãªã—             | **å·®åˆ†ã‚ã‚Šï¼ˆã‚³ãƒ¼ãƒ‰å¤‰æ›´å·®åˆ†ã®ã¿ï¼‰** |
| `terraform apply` | å¤‰æ›´ã‚ã‚Šï¼ˆå·»ãæˆ»ã‚Šï¼‰ | å¤‰æ›´ã‚ã‚Šï¼ˆå·»ãæˆ»ã‚Šï¼‹å¤‰æ›´ï¼‰         |
| `cdk deploy`      | å¤‰æ›´ãªã—             | **å¤‰æ›´ã‚ã‚Šï¼ˆå·»ãæˆ»ã‚Šï¼‹å¤‰æ›´ï¼‰**     |
